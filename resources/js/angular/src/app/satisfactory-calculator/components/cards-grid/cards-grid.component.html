<div class="board-viewport" #viewport (mousedown)="onCanvasPointerDown($event)" (wheel)="onWheel($event)">
    <div
        class="board-content"
        [style.width.px]="contentWidth"
        [style.height.px]="contentHeight"
        [style.transform]="viewTransform"
    >
        <svg class="edge-layer" [attr.width]="contentWidth" [attr.height]="contentHeight">
            <defs>
                <marker id="edgeArrow" markerWidth="8" markerHeight="8" refX="7" refY="4" orient="auto">
                    <path d="M0,0 L8,4 L0,8 z" fill="#f2f200"></path>
                </marker>
            </defs>

            <g *ngFor="let edge of renderedEdges; trackBy: trackById">
                <line
                    class="edge-line"
                    [class.animated]="isShowingDirection"
                    [attr.x1]="edge.x1"
                    [attr.y1]="edge.y1"
                    [attr.x2]="edge.x2"
                    [attr.y2]="edge.y2"
                    marker-end="url(#edgeArrow)"
                ></line>
                <text
                    *ngIf="isShowingDirection"
                    class="edge-label"
                    [attr.x]="(edge.x1 + edge.x2) / 2"
                    [attr.y]="(edge.y1 + edge.y2) / 2 - 6"
                    text-anchor="middle"
                >
                    {{ edge.label }}
                </text>
            </g>
        </svg>

        <div class="node-layer">
            <div
                *ngFor="let node of nodes; trackBy: trackById"
                class="node-wrapper"
                [style.transform]="'translate(' + getNodePosition(node.id).x + 'px, ' + getNodePosition(node.id).y + 'px)'"
                [style.width.px]="itemSize"
                [style.height.px]="itemSize"
                (mousedown)="onNodePointerDown($event, node)"
            >
                <satisfactory-card
                    [data]="node"
                    [isHighlighted]="isNodeHighlighted(node)"
                    [suppressHint]="suppressCardHints"
                    (selectRecipe)="openRecipeSelectorForNode(node)"
                    appReady
                ></satisfactory-card>
            </div>
        </div>
    </div>
</div>

<div class="overlay">
    <button class="overlay-element input" mat-button (click)="openDialog()">New Recipe</button>
    <div class="overlay-panel right">
        <div class="zoom-controls">
            <button class="overlay-element center" mat-button (click)="centerView()">Center</button>
            <span class="overlay-element zoom rounded-md">x{{boardZoomLevel}}</span>
        </div>

        <button
            class="overlay-element direction"
            mat-button
            (mousedown)="showDirection()"
            (mouseup)="stopDirection()"
            (mouseleave)="stopDirection()"
            (touchstart)="showDirection()"
            (touchend)="stopDirection()"
            (touchcancel)="stopDirection()"
        >
            {{ isShowingDirection ? 'Showing directions' : 'Hold Space for lines direction' }}
        </button>

        <div class="summary-origin" cdkOverlayOrigin #summaryOrigin="cdkOverlayOrigin"></div>
        <ng-template
            cdkConnectedOverlay
            [cdkConnectedOverlayOrigin]="summaryOrigin"
            [cdkConnectedOverlayOpen]="true"
            [cdkConnectedOverlayHasBackdrop]="false"
            [cdkConnectedOverlayPositions]="summaryPositions"
        >
            <div class="overlay-element rounded-lg summary overlay-summary">
                <mat-accordion multi class="example-headers-align">
                    <mat-expansion-panel *ngFor="let section of ingredientsData | keyvalue">
                        <mat-expansion-panel-header>
                            <mat-panel-title> {{section.key | titlecase}} </mat-panel-title>
                            <mat-panel-description>
                                Ingridients: {{section.value.length}}
                            </mat-panel-description>
                        </mat-expansion-panel-header>
                        <mat-list>
                        @for (ingredient of section.value; track ingredient) {
                            <mat-list-item>
                                <img matListItemAvatar basePath [path]="getItemImageUrl(ingredient.itemName)" alt="...">
                                <p matListItemTitle class="summary-item-name" [class.is-selected]="isPanelItemSelected(ingredient.itemName)" (click)="onPanelItemClick(ingredient.itemName)">{{ingredient.itemName}}</p>
                                <p  matListItemLine>
                                    <span>{{ingredient.amount}} p/m</span>
                                </p>
                                <button type="button" matListItemMeta class="mat-mdc-list-item-meta mdc-list-item__end summary-recipe-button" (click)="openRecipeSelectorForItem(ingredient.itemName)">Recipe</button>
                            </mat-list-item>
                        }
                        </mat-list>
                    </mat-expansion-panel>
                </mat-accordion>
            </div>
        </ng-template>

    </div>
</div>
